version: "3.9"

services:
  api-service:
    image: library-platform-api-service
    environment:
      - API_PORT=5000
      - DB_HOST=db-service
      - DB_NAME=library
      - DB_USER=library_user
      - DB_PASSWORD=library_pass
      - MINIO_ENDPOINT=http://file-storage:9000
      - ES_HOST=search-service
    depends_on:
      - db-service
      - file-storage
      - search-service
    networks:
      - library-net

  db-service:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=library
      - POSTGRES_USER=library_user
      - POSTGRES_PASSWORD=library_pass
    volumes:
      - db-data:/var/lib/postgresql/data
      - ./db-service/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - library-net

  search-service:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.13.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    volumes:
      - es-data:/usr/share/elasticsearch/data
    networks:
      - library-net

  file-storage:
    image: minio/minio
    environment:
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=admin12345
    command: server /data
    volumes:
      - minio-data:/data
    ports:
      - "9000:9000"
    networks:
      - library-net

  reverse-proxy:
    image: library-platform-reverse-proxy
    depends_on:
      - api-service
    ports:
      - "8080:80"
    networks:
      - library-net

networks:
  library-net:

volumes:
  db-data:
  es-data:
  minio-data: